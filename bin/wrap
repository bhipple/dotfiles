#!/usr/bin/env zsh
set -euxo pipefail

dir=$(pwd)
cmd=$@

echo "Setting up bwrap in $dir for $cmd"

bwrap \
  --unshare-all \
  --share-net \
  --tmpfs /tmp \
  --proc /proc \
  --dev /dev \
  --ro-bind /bin /bin \
  --ro-bind /etc /etc \
  --ro-bind /nix /nix \
  --ro-bind /run/current-system /run/current-system \
  --ro-bind /usr/bin /usr/bin \
  --ro-bind ~/Downloads ~/Downloads \
  --ro-bind ~/.nix-defexpr/channels ~/.nix-defexpr/channels \
  --ro-bind ~/.nix-profile ~/.nix-profile \
  --ro-bind ~/.zgenom ~/.zgenom \
  --ro-bind ~/.zsh ~/.zsh \
  --ro-bind ~/.zshrc ~/.zshrc \
  --ro-bind ~/dotfiles ~/dotfiles \
  --ro-bind ~/dotfiles_local ~/dotfiles_local \
  --ro-bind ~/git/nixos-25.11 ~/git/nixos-25.11 \
  --ro-bind ~/git/nixpkgs ~/git/nixpkgs \
  --bind ~/.local/share/crush ~/.local/share/crush \
  --bind $dir $dir \
  --new-session \
  -- $cmd
